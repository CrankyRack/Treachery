### Ruling Party Popularity Effects Stolen From KaiserreduX
### Written by ~mw~
### Retooled by Alpinia
### Ported to Trechery by Skrutti
# How to use:
#
#	increase_ruling_party_popularity_by_5 = yes
#
#	set_temp_variable = { ideology_change_var = X } - increases ruling party popularity by X amount
#	change_ruling_party_popularity = yes
#
#	default_party_popularity_PP_gain = yes -- sets the PP gain to the default behaviour (i.e., tied to the ruling party)
#
#	set_variable = { political_power_ideology = token:ideology } -- maps PP gain to the ideology in the variable
#	map_party_popularity_PP_gain_to_ideology = yes
#
#	set_variable = { coalition_partner_var = token:ideology } -- adds/removes a coalition partner
#	add_to_coalition = yes
#	remove_from_coalition = yes
#
#	end_coalition = yes  -- disables any active coalitions
#
#	disable_party_popularity_PP_gain = yes -- disables popularity PP gain altogether
#

default_party_popularity_PP_gain = {
	if = {
		limit = {
			NOT = {
				has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
			}
		}
		clr_country_flag = party_popularity_disabled
		clear_variable = political_power_ideology
		hidden_effect = {
			if = {
				limit = {
					has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
				}
				remove_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
			}
			add_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
		}
	}
}

map_party_popularity_PP_gain_to_ideology = {
	if = {
		limit = {
			NOT = {
				has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
			}
		}
		clr_country_flag = party_popularity_disabled
		hidden_effect = {
			if = {
				limit = {
					has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
				}
				remove_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
			}
			add_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
		}
	}
	set_temp_variable = { coalition_partner_var = political_power_ideology }
	remove_from_coalition = yes
}

disable_party_popularity_PP_gain = {
	if = {
		limit = {
			OR = {
				has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
				has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
			}
		}
		set_country_flag = party_popularity_disabled
		clear_variable = political_power_ideology
		hidden_effect = {
			if = {
				limit = {
					has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
				}
				remove_dynamic_modifier = { modifier = party_popularity_dynamic_modifier }
			}
			if = {
				limit = {
					has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
				}
				remove_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_ideology_mapped }
			}
		}
	}
}

add_to_coalition = {
	if = {
		limit = {
			NOT = {
				check_variable = { political_power_ideology = coalition_partner_var }
				is_in_array = { coalition_partners = coalition_partner_var }
			}
		}
		custom_effect_tooltip = add_to_coalition
	}
	if = {
		limit = {
			NOT = {
				is_in_array = { coalition_partners = coalition_partner_var }
				has_government = var:coalition_partner_var
				check_variable = { political_power_ideology = coalition_partner_var }
			}
		}
		add_to_array = { coalition_partners = coalition_partner_var }
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_coalition }
				}
			}
			add_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_coalition }
		}
		add_to_variable = { coalition_pp_gain = party_popularity@var:coalition_partner_var }
	}
}

remove_from_coalition = {
	if = {
		limit = {
			is_in_array = { coalition_partners = coalition_partner_var }
		}
		custom_effect_tooltip = remove_from_coalition
		if = {
			limit = {
				has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_coalition }
				check_variable = { coalition_partners^num = 1 }
			}
			remove_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_coalition }
			clear_variable = coalition_pp_gain
			clear_array = coalition_partners
		}
		else = {
			remove_from_array = { coalition_partners = coalition_partner_var }
			subtract_from_variable = { coalition_pp_gain = party_popularity@var:coalition_partner_var }
		}
	}
}

end_coalition = {
	if = {
		limit = {
			has_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_coalition }
		}
		remove_dynamic_modifier = { modifier = party_popularity_dynamic_modifier_coalition }
	}
	clear_variable = coalition_pp_gain
	clear_array = coalition_partners
}

change_ruling_party_popularity = {
	if = {
		limit = {
			OR = {
				check_variable = { ideology_change_var > 1 }
				check_variable = { ideology_change_var < -1 }
			}
		}
		multiply_temp_variable = { ideology_change_var = 0.01 }
	}
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_2 = {
	set_temp_variable = { ideology_change_var = 0.02 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_3 = {
	set_temp_variable = { ideology_change_var = 0.03 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_5 = {
	set_temp_variable = { ideology_change_var = 0.05 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_10 = {
	set_temp_variable = { ideology_change_var = 0.1 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_15 = {
	set_temp_variable = { ideology_change_var = 0.15 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_20 = {
	set_temp_variable = { ideology_change_var = 0.2 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_25 = {
	set_temp_variable = { ideology_change_var = 0.25 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_30 = {
	set_temp_variable = { ideology_change_var = 0.3 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_35 = {
	set_temp_variable = { ideology_change_var = 0.35 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_40 = {
	set_temp_variable = { ideology_change_var = 0.4 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_45 = {
	set_temp_variable = { ideology_change_var = 0.45 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

increase_ruling_party_popularity_by_50 = {
	set_temp_variable = { ideology_change_var = 0.5 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_1 = {
	set_temp_variable = { ideology_change_var = -0.01 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_2 = {
	set_temp_variable = { ideology_change_var = -0.02 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_3 = {
	set_temp_variable = { ideology_change_var = -0.03 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_5 = {
	set_temp_variable = { ideology_change_var = -0.05 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_10 = {
	set_temp_variable = { ideology_change_var = -0.1 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_15 = {
	set_temp_variable = { ideology_change_var = -0.15 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_20 = {
	set_temp_variable = { ideology_change_var = -0.2 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_25 = {
	set_temp_variable = { ideology_change_var = -0.25 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_30 = {
	set_temp_variable = { ideology_change_var = -0.3 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_35 = {
	set_temp_variable = { ideology_change_var = -0.35 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_40 = {
	set_temp_variable = { ideology_change_var = -0.4 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_45 = {
	set_temp_variable = { ideology_change_var = -0.45 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

decrease_ruling_party_popularity_by_50 = {
	set_temp_variable = { ideology_change_var = -0.5 }
	add_popularity = {
		ideology = var:current_party_ideology_group
		popularity = ideology_change_var
	}
}

add_conservative_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:democratic }
		add_to_coalition = yes
	}
	custom_effect_tooltip = conservative_will_join_coalition_tt
}

add_liberalism_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:liberalism }
		add_to_coalition = yes
	}
	custom_effect_tooltip = liberalism_will_join_coalition_tt
}

add_progressivism_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:progressivism }
		add_to_coalition = yes
	}
	custom_effect_tooltip = progressivism_will_join_coalition_tt
}

add_democratic_socialism_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:democratic_socialism }
		add_to_coalition = yes
	}
	custom_effect_tooltip = sdemocratic_socialism_will_join_coalition_tt
}

add_vanguardism_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:vanguardism }
		add_to_coalition = yes
	}
	custom_effect_tooltip = vanguardism_will_join_coalition_tt
}

add_revolutionary_socialism_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:revolutionary_socialism }
		add_to_coalition = yes
	}
	custom_effect_tooltip = revolutionary_socialism_will_join_coalition_tt
}

add_monarchist_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:monarchist }
		add_to_coalition = yes
	}
	custom_effect_tooltip = monarchist_will_join_coalition_tt
}

add_authoritarian_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:authoritarian }
		add_to_coalition = yes
	}
	custom_effect_tooltip = authoritarian_will_join_coalition_tt
}

add_Patrimonialism_to_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:Patrimonialism }
		add_to_coalition = yes
	}
	custom_effect_tooltip = Patrimonialism_will_join_coalition_tt
}



remove_conservative_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:democratic }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = conservative_will_leave_coalition_tt
}

remove_liberalism_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:liberalism }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = liberalism_will_leave_coalition_tt
}

remove_progressivism_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:progressivism }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = progressivism_will_leave_coalition_tt
}

remove_democratic_socialism_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:democratic_socialism }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = democratic_socialism_will_leave_coalition_tt
}

remove_vanguardism_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:vanguardism }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = vanguardism_will_leave_coalition_tt
}

remove_revolutionary_socialism_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:revolutionary_socialism }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = revolutionary_socialism_will_leave_coalition_tt
}

remove_monarchist_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:monarchist }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = monarchist_will_leave_coalition_tt
}

remove_authoritarian_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:authoritarian }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = authoritarian_will_leave_coalition_tt
}

remove_Patrimonialism_from_coalition = {
	hidden_effect = {
		set_temp_variable = { coalition_partner_var = token:Patrimonialism }
		remove_from_coalition = yes
	}
	custom_effect_tooltip = Patrimonialism_will_leave_coalition_tt
}



effect_intel = {
create_intelligence_agency = yes
}



# the following effects are excellent for preserving a puppet's government so it doesn't change to the overlord
# use the first command in the scope of the about-to-be-puppeted country right before the puppet command is executed
# and then the second, also in the scope of the puppet, right after
get_current_government_type = {
	clear_variable = original_government_type
	set_variable = { original_government_type = current_party_ideology_group }

	if = {
		limit = { has_elections = yes }
		set_country_flag = original_government_type_had_elections
	}

	clear_array = original_popularities
	add_to_array = { original_popularities = party_popularity_100@totalist }
	add_to_array = { original_popularities = party_popularity_100@syndicalist }
	add_to_array = { original_popularities = party_popularity_100@radical_socialist }
	add_to_array = { original_popularities = party_popularity_100@social_democrat }
	add_to_array = { original_popularities = party_popularity_100@social_liberal }
	add_to_array = { original_popularities = party_popularity_100@market_liberal }
	add_to_array = { original_popularities = party_popularity_100@social_conservative }
	add_to_array = { original_popularities = party_popularity_100@authoritarian_democrat }
	add_to_array = { original_popularities = party_popularity_100@paternal_autocrat }

	set_temp_variable = { sum = 100 }
	for_each_loop = {
		array = original_popularities
		subtract_from_temp_variable = { sum = v }
	}
	add_to_array = { original_popularities = sum } #last value (natpop), calculated directly to avoid rounding errors

	if = {
		limit = { has_coalition = yes }
		for_each_loop = {
			array = coalition_partners
			add_to_array = { original_coalitions = v }
		}
	}
}

restore_previous_government_type = {
	hidden_effect = {
		if = {
			limit = { has_variable = original_government_type } #needed to avoid a CTD
			if = {
				limit = { has_country_flag = original_government_type_had_elections }
				clr_country_flag = original_government_type_had_elections
				set_politics = {
					ruling_party = var:original_government_type
					elections_allowed = yes
				}
			}
			else = {
				set_politics = {
					ruling_party = var:original_government_type
					elections_allowed = no
				}
			}
		}
		clear_variable = original_government_type

		if = {
			limit = { check_variable = { original_popularities^num > 0 } }
			set_popularities = {
				totalist = original_popularities^0
				syndicalist = original_popularities^1
				radical_socialist = original_popularities^2
				social_democrat = original_popularities^3
				social_liberal = original_popularities^4
				market_liberal = original_popularities^5
				social_conservative = original_popularities^6
				authoritarian_democrat = original_popularities^7
				paternal_autocrat = original_popularities^8
				national_populist = original_popularities^9
			}
			clear_array = original_popularities
		}

		if = {
			limit = { check_variable = { original_coalitions^num > 0 } }
			for_each_loop = {
				array = original_coalitions
				set_temp_variable = { coalition_partner_var = v }
				add_to_coalition = yes
			}
			clear_array = original_coalitions
		}
	}
}
